{% extends '::BOLayout.html.twig' %}

     {% block pagewrapper %}

         <div id="page-wrapper">

             <div id="formParams">

                 <div class="row">
                     <div class="bs-example">
                         <ul class="breadcrumb">
                             <li><a href="{{ path('ffbb_accueil_connect') }}">Accueil</a></li>
                             <li><a href="{{ path('ffbb_poules_choisir_liste') }}">Choix de la liste d'équipes</a></li>
                             <li><a href="{{ path('ffbb_poule_choisir_groupe', {'idListe': idListe}) }}">Choix de groupes</a></li>
                             <li class="active">Participants</li>
                         </ul>
                     </div>

                     <div class="col-lg-12">
                         <h3 class="page-header">Sélectionnez vos critères et contraintes </h3>
                         <h4>{{ nomListe }} | {{ nomGroupe }}</h4>
                      </div>
                     <!-- /.col-lg-12 -->
                     <div class="col-lg-12">
                         <h5 style="float: right"> <strong> (* champs obligatoires)</strong>  </h5>
                     </div>
                 </div>
                 <!-- /.row -->
                 <div class="row">
                     {#(* Saisie obligatoire)#}

                     <!-- Type de rencontre bloc -->
                     <div class="col-lg-3">


                         <div class="panel panel-default">
                             <div class="panel-heading">
                                 <strong> Type de rencontre*</strong>
                             </div>
                             <!-- /.panel-heading -->
                             <div class="panel-body">

                                 <div class="form-group">
                                     <div class="radio">
                                         <label>
                                             <input type="radio" name="typeRencontre" id="typeRencontre1"
                                                    value="allerRetour" checked onclick="typeAllerRetour();">Match aller retour
                                         </label>
                                     </div>
                                     <div class="radio">
                                         <label>
                                             <input type="radio" name="typeRencontre" id="typeRencontre2"
                                                    value="allerSimple" onclick="typeAller();">Match aller simple
                                         </label>
                                     </div>
                                     <div class="radio">
                                         <label>
                                             <input type="radio" name="typeRencontre" id="typeRencontre3"
                                                    value="plateau" onclick="typePlateau();">Plateau
                                         </label>
                                     </div>
                                 </div>

                             </div>
                             <!-- /.panel-body -->
                         </div>
                     </div>
                     <!-- /. Type de rencontre bloc -->


                     <!-- Nombre de journées bloc -->
                     <div class="col-lg-3" id="nbrJournee" style="display: none">
                         <div class="panel panel-default">
                             <div class="panel-heading">
                                 {#<strong>  Nombre de journées </strong>#}
                                 Nombre de journées
                             </div>
                             <!-- /.panel-heading -->
                             <div class="panel-body">
                                 <div class="form-group">
                                     <input type="number" min="1" class="form-control">

                                 </div>

                             </div>
                             <!-- /.panel-body -->
                         </div>
                     </div>
                     <!-- /. Nombre de journées bloc -->

                     <!-- Nombre de rencontres par journée bloc -->
                     <div class="col-lg-3" id="nbrRencontre" style="display: none">
                         <div class="panel panel-default">
                             <div class="panel-heading">
                                 Nombre de rencontres par journée
                             </div>
                             <!-- /.panel-heading -->
                             <div class="panel-body">
                                 <div class="form-group">
                                     <input type="number" min="0" class="form-control">
                                 </div>

                             </div>
                             <!-- /.panel-body -->
                         </div>
                     </div>

                     <!-- /. Nombre de rencontres par journée bloc -->

                     <!-- Ajouter une contrainte bloc -->
                     <div class="col-lg-3" id="ajoutContrainte" style="display: none">
                         <div class="panel panel-default">
                             <div class="panel-heading">
                                 Ajouter une contrainte
                             </div>
                             <!-- /.panel-heading -->
                             <div class="panel-body">
                                 <div class="form-group">
                                     <label class="checkbox-inline">
                                         <input type="checkbox">Toutes les équipes doivent accueillir au moins une fois
                                     </label>

                                 </div>

                             </div>
                             <!-- /.panel-body -->
                         </div>
                     </div>
                     <!-- /. Ajouter une contrainte bloc -->


                 </div>
                 <!-- /.row -->

                 <div class="row">
                     <!-- Nombre de poules bloc -->
                     <div class="col-lg-3">
                         <div class="panel panel-default">
                             <div class="panel-heading">
                                 <strong> Nombre de poules* </strong>
                             </div>
                             <!-- /.panel-heading -->
                             <div class="panel-body">

                                 <div class="form-group">
                                     <input id="inputPoulesNbr" type="number" min="1" class="form-control" required>
                                 </div>

                             </div>
                             <!-- /.panel-body -->
                         </div>
                     </div>
                     <!-- /. Ajouter une contrainte bloc -->

                 </div>
                 <div class="row">
                     <div class="panel panel-default">
                         <div class="panel-heading">
                            <span id="contrainteInterdiction" style="cursor:pointer"> Ajouter des contraintes d'interdiction </span>
                         </div>
                         <!-- /.panel-heading -->
                         <div class="panel-body" id="contrainteInterdictionBody" style="display: none">

                             <table id="mesContraintes" class="table table-striped table-bordered table-hover">
                                 <thead>
                                 <tr>
                                     <th><h4>#</h4></th>
                                     <th><h4>Equipe N°1</h4></th>
                                     <th><h4>Equipe N°2</h4></th>
                                 </tr>
                                 </thead>
                                 <tr>
                                     <td id="interdiction">
                                         Interdiction
                                     </td>
                                     <td>
                                         <select id="equipe1" class="equipe1" onchange="selectEquipe(this,this.parentNode.parentNode.getElementsByClassName('equipe2'))">
                                             <option disabled selected> -- selectionnez une option -- </option>
                                             {% for detailsVille in detailsVilles %}

                                                 <option value={{ detailsVille.id }}>{{ detailsVille.nom }}</option>
                                             {% endfor %}
                                         </select>
                                     </td>
                                     <td>

                                         {#<select id="equipe2" class="equipe2" onchange="selectEquipe2()">#}
                                         <select id="equipe2" class="equipe2">
                                             <option disabled selected> -- selectionnez une option -- </option>
                                             {% for detailsVille in detailsVilles %}

                                                 <option value={{ detailsVille.id }}>{{ detailsVille.nom }}</option>
                                             {% endfor %}
                                         </select>

                                     </td>
                                 </tr>
                             </table>
                             <br>

                             <button onclick="myCreateFunction()" class="btn btn-primary ">Ajouter</button>
                             <button onclick="myDeleteFunction()" class="btn btn-primary">Supprimer</button>
                             {#<button onclick="getContraintes()" class="btn btn-primary">mes contraintes</button>#}

                         </div>


                         <!-- /.panel-body -->


                     </div>

                 </div>

                 <div class="row">
                     <div class="panel panel-default">
                         <div class="panel-heading">
                             <span id="contrainteRepartition" style="cursor:pointer"> Ajouter des contraintes de répartition homogène</span>
                         </div>
                         <!-- /.panel-heading -->
                         <div class="panel-body" id="contrainteRepartitionBody" style="display: none">
                         {#<div class="panel-body" id="contrainteRepartitionBody">#}
                             <div class="panel-body">
                                 {#<div class="table-responsive">#}
                                 <div>
                                     <table class="table table-striped table-bordered table-hover" id="tableContrainteRepartitionHomogene">
                                         <thead>
                                         <tr>
                                             <th style="display: none"></th>
                                             <th><strong>Equipe</strong></th>
                                             <th><strong>Catégorie</strong></th>
                                         </tr>
                                         </thead>
                                         <tbody>

                                         {% for key, detailsVille in detailsVilles %}
                                             <tr>
                                                 <td style="display: none" id="repartitionHomogeneIdVille{{ key }}">{{ detailsVille.id }}</td>
                                                 <td>{{ detailsVille.nom }}</td>
                                                 <td>
                                                     <select class="form-control" id="repartitionHomogeneOption{{ key }}" style="width: 100%;">
                                                         <option value="Aucun" disabled selected> -- Aucun -- </option>
                                                         <option value="Espoir">Espoir</option>
                                                         <option value="Descendant">Descendant</option>
                                                         <option value="Promu">Promu</option>
                                                         <option value="EquipeNiveauA">Equipe de niveau A</option>
                                                         <option value="EquipeNiveauB">Equipe de niveau B</option>
                                                         <option value="EquipeNiveauC">Equipe de niveau C</option>
                                                         <option value="TeteSerie1">Tête de série 1</option>
                                                         <option value="TeteSerie2">Tête de série 2</option>
                                                     </select>
                                                 </td>
                                             </tr>


                                         {% endfor %}

                                         </tbody>
                                     </table>
                                 </div>
                                 <!-- /.table-responsive -->
                             </div>
                             <!-- /.panel-body -->

                         </div>
                         <!-- /.panel-body -->
                     </div>

                     {#<button type="button" id="verifRepartitionHomogenebtn" class="btn btn-info-poule" onclick="verifRepartitionHomogene()">Valider répartition</button>#}
                 </div>
                 <div class="row">
                     {#<button id="lancerCalculBtn" type="submit" class="btn btn-primary pull-right"> Lancer le calcul</button>#}
                     {#<button id="lancerCalculBtn" type="button" class="btn btn-primary pull-right"> Lancer le calcul</button>#}
                     <label id="lancerCalculBtn" class="btn btn-primary pull-right"> Lancer le calcul</label>
                 </div>

             </div>

         </div>

         {% block javascript %}

             {{ parent() }}





             <script language="javascript">





                 function typePlateau() {

                     var plateau = document.getElementById("typeRencontre3").checked;
                     if (plateau) {
                         document.getElementById("nbrJournee").style.display = "block";
                         document.getElementById("nbrRencontre").style.display = "block";
                         document.getElementById("ajoutContrainte").style.display = "block";
                     }

                 }

                 function typeAllerRetour() {

                     var allerRetour = document.getElementById("typeRencontre1").checked;
                     if (allerRetour) {
                         document.getElementById("nbrJournee").style.display = "none";
                         document.getElementById("nbrRencontre").style.display = "none";
                         document.getElementById("ajoutContrainte").style.display = "none";
                     }

                 }

                 function typeAller() {

                     var aller = document.getElementById("typeRencontre2").checked;
                     if (aller) {
                         document.getElementById("nbrJournee").style.display = "none";
                         document.getElementById("nbrRencontre").style.display = "none";
                         document.getElementById("ajoutContrainte").style.display = "none";

                     }
                 }

                 $(document).ready(function(){
                     $("#contrainteInterdiction").click(function(){
                         $("#contrainteInterdictionBody").toggle();
                     });
                 });

                 $(document).ready(function(){
                     $("#contrainteRepartition").click(function(){
                         $("#contrainteRepartitionBody").toggle();

                     });
                 });


                 // dupliquer élément
                 $('#additional-field-model').duplicateElement({
                     "class_remove": ".remove-this-field",
                     "class_create": ".create-new-field"
                 });


                 // javascript pour des contraintes
                 // JS pour ajouter des contraintes d'interdictions
                 $("#btnAjouteInterdiction").click(function(){
                     console.log("test");
                 });



                 // javascript quand on clique sur le bouton 'lancer le calcul'
                 $(document).ready(function(){
                     $("#lancerCalculBtn").click(function(){
                        console.log("------------------------------------ debug bouton lancer calcul ---------------------------------------");

                         // récupérer le type de match
                         var typeMatch =   $('input[name=typeRencontre]:checked', '#formParams').val();
                         console.log("typeMatch: " + typeMatch);

                         // récupérer l'id du groupe
                         var idGroupe = {{ idGroupe }};
                         console.log("idGroupe : " + idGroupe);

                         // récupérer le nombre de poules
                         var poulesNbr = $("#inputPoulesNbr").val();
                         console.log("poulesNbr : " + poulesNbr );

                         // controler le champ obligatoire (le nombre de poules)
//                         if (typeMatch == "plateau"){
//                             alert("Ce type de match n'est pas encore supporté. Veuillez choisir un autre type de match");
//
//                         }


                         if(  (typeMatch == "allerRetour" || typeMatch == "allerSimple") && (poulesNbr == "" || parseInt(poulesNbr)<2 ) ){
                            alert("Veuillez vérifier que le nombre de poules donné est valide");
                         }
                         else if (typeMatch == "plateau"  && ((poulesNbr == "" || parseInt(poulesNbr)<1 )) ) {
                             alert("Veuillez vérifier que le nombre de poules donné est valide");
                         }
                         else{
                             var interdictions = getContraintes();
                             var repartitionsHomogenes = verifRepartitionHomogene();

                             console.log("repartitionsHomogenes: " + repartitionsHomogenes );

                             // si la vérification des répartitions homogenes retourne une erreur
                             if(repartitionsHomogenes == "erreur" ){
                                 return;
                             }


                            alert("Le calcul est en cours. Vous recevrez un mail pour vous avertir de la mise à disposition de vos résultats de calculs");


                            // agréger les input params
                            var inputParams = {typeMatch: typeMatch, poulesNbr: poulesNbr, idGroupe: idGroupe, interdictions: interdictions, repartitionsHomogenes  : repartitionsHomogenes };
                            console.log("inputParams : " + JSON.stringify(inputParams));


                            // AJAX requete
                             $.ajax({
                                 url: '/admin/poules/lancer-calcul/',
                                 type: 'POST',
                                 data: inputParams,
                                 dataType : "json",
                                 success: function(data, textStatus, jqXHR)
                                 {
                                     console.log('data: ' + JSON.stringify(data));

                                     var urlRedirect = window.location.origin + "/admin/rapports";
                                     console.log('urlRedirect: ' + urlRedirect);

                                     // redirect à la page rapport
                                     window.location = urlRedirect;

                                 },
                                 error: function(jqXHR, textStatus, errorThrown)
                                 {
                                     // Handle errors here
                                     console.log('ERRORS: ' + textStatus);
                                 }
                             });

                        }

                     });

                 });



                 function myCreateFunction() {
                     var table = $('#mesContraintes tbody');
                     var children = table.find('tr');
                     var numberChilds = children.length;
                     var lastChild = children.last();
                     console.log(lastChild);
                     table.append(lastChild[0].outerHTML);

                 }

                 function myDeleteFunction() {
                     document.getElementById("mesContraintes").deleteRow(0);
                 }


                 ////////traitement des interdictions///////////////
                 function selectEquipe(select1,select2) {
                     select2 = select2[0];
                     var lengthEquipe2 = select2.options.length;
                     for (var i= 0 ; i< lengthEquipe2 ; i++ ){

                         select2.options[i].disabled = false;

                     }
                      var x = select1.selectedIndex;
                     select2.options[x].disabled = true;
                 }

//                 function selectEquipe2() {
//
//
//                     var interdictionTab = [];
//                     var x = document.getElementById("equipe1").selectedIndex;
//                     if(!x){
//                         alert("Veuillez choisir une équipe de la première liste SVP")
//                     }
//                     else{
//                         interdictionTab[0] = 1;
//                         interdictionTab[1] = document.getElementById("equipe1").value;
//                         interdictionTab[2] = document.getElementById("equipe2").value;
//
//                     }
//                     alert(interdictionTab);
//
//                 }

                 ///////////récupération contraintes /////////////

                 function getContraintes(){
                     var mesLignes = document.getElementById("mesContraintes").rows;
                     var tabContraintes = {};
                     for (i = 1; i < mesLignes.length; i++) {
                         var maLigne = mesLignes[i];
                         var td1 = maLigne.getElementsByTagName("td")[1];
                         var td2 = maLigne.getElementsByTagName("td")[2];
                         var monEquipe1 = parseInt(td1.getElementsByClassName("equipe1")[0].value);
                         var monEquipe2 = parseInt(td2.getElementsByClassName("equipe2")[0].value);

                         console.log("monEquipe1: " + monEquipe1);
                         console.log("monEquipe2: " + monEquipe2);

                         if ((monEquipe1) && (monEquipe2 )){
                             var maContrainte = [monEquipe1, monEquipe2];
                             tabContraintes[i] = maContrainte;

                         };

                   }


                     return tabContraintes;

//                     console.log(tabContraintes);
                 }

                 //////////traitement de la répartition homogène////////////

                 function verifRepartitionHomogene(){

                     var length = document.getElementById("tableContrainteRepartitionHomogene").rows.length;
//                     var ligne = document.getElementById("tableContrainteRepartitionHomogene").rows;

                     console.log("length: " + length);

                     var mesRepartitions = [];
                     for (i = 0; i < length-1; i++) {

                         var element = "repartitionHomogeneOption"+i;

                         var repartition = document.getElementById(element).value;

                         mesRepartitions.push(repartition);

                     }

                     //declaration des variables de nbrOccurences
                     var nbrEspoir = 0; var nbrDescendant = 0; var nbrPromu = 0; var nbrEquipeNiveauA = 0; var nbrEquipeNiveauB = 0; var nbrEquipeNiveauC = 0; var nbrTeteSerie2 = 0; var nbrTeteSerie1 = 0;

                     for (j = 0; j < mesRepartitions.length; j++) {

                         if (mesRepartitions[j] == "Espoir") {
                             nbrEspoir += 1;
                         }
                         else if (mesRepartitions[j] == "Descendant") {
                             nbrDescendant += 1;
                         }
                         else if (mesRepartitions[j] == "Promu") {
                             nbrPromu += 1;
                         }
                         else if (mesRepartitions[j] == "EquipeNiveauA") {
                             nbrEquipeNiveauA += 1;
                         }
                         else if (mesRepartitions[j] == "EquipeNiveauB") {
                             nbrEquipeNiveauB += 1;
                         }
                         else if (mesRepartitions[j] == "EquipeNiveauC") {
                             nbrEquipeNiveauC += 1;
                         }
                         else if (mesRepartitions[j] == "TeteSerie2") {
                             nbrTeteSerie2 += 1;
                         }
                         else if (mesRepartitions[j] == "TeteSerie1") {
                             nbrTeteSerie1 += 1;
                         }

                     }

                     //test sur le nombre d'occurence
                     if(nbrEspoir == 1){
                         alert("La catégorie Espoir doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                        return "erreur";
                     }
                     if(nbrDescendant == 1){
                         alert("La catégorie Descendant doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }
                     if(nbrPromu == 1){
                         alert("La catégorie Promu doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }
                     if(nbrEquipeNiveauA == 1){
                         alert("La catégorie Equie de niveau A doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }
                     if(nbrEquipeNiveauB == 1){
                         alert("La catégorie Equie de niveau B doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }
                     if(nbrEquipeNiveauC == 1){
                         alert("La catégorie Equie de niveau C doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }
                     if(nbrTeteSerie2 == 1){
                         alert("La catégorie Tête de série 2 doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }
                     if(nbrTeteSerie1 == 1){
                         alert("La catégorie Tête de série 1 doit contenir au moins deux équipes. Veuillez choisir au moins une équipe supplémentaire pour cette catégorie  ou annuler la catégorie sélectionnée pour votre équipe.");
                         return "erreur";
                     }


//                     var mesRepartitionsHomogenes = [];
                     var mesRepartitionsHomogenes = {};
                     for (i = 0; i < length-1; i++) {

                         var element = "repartitionHomogeneOption"+i;
                         var idVille = "repartitionHomogeneIdVille"+i;

                         var categorie = document.getElementById(element).value;
                         var ville = parseInt(document.getElementById(idVille).textContent);

                         var maRepartition = null;

                         if(categorie !="Aucun"){

//                             maRepartition = ville+':'+categorie;
//                             mesRepartitionsHomogenes.push(maRepartition);

                             if(categorie in mesRepartitionsHomogenes){
                                 mesRepartitionsHomogenes[categorie].push(ville);
                             }
                             else{
                                 mesRepartitionsHomogenes[categorie] = [ville];

                             }
                         }

                     }
                     return mesRepartitionsHomogenes;

//                     console.log(mesRepartitionsHomogenes);


                 }




             </script>

         {% endblock %}

     {% endblock %}

